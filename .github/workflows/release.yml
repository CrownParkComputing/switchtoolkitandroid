name: Create Release

on:
  push:
    branches:
      - master
    paths:
      - 'VERSION.txt'
      - 'releases/*.apk'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Read version
        id: version
        run: |
          VERSION=$(cat VERSION.txt)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Check if release exists
        id: check_release
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release already exists, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release does not exist, will create..."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract release notes
        if: steps.check_release.outputs.exists == 'false'
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extract release notes from CHANGELOG.md
          NOTES=$(awk "/## \[$VERSION\]/,/^---$/" CHANGELOG.md | sed '1d;$d' | sed '/^$/d' || echo "Release version $VERSION")
          
          # If no notes found, use default
          if [ -z "$NOTES" ]; then
            NOTES="Release version $VERSION"
          fi
          
          # Save notes to file first
          echo "$NOTES" > release_notes.txt
          
          # Add SHA256 if release info exists
          if [ -f "releases/release-info-v${VERSION}.json" ]; then
            SHA256=$(jq -r '.sha256' "releases/release-info-v${VERSION}.json")
            echo "" >> release_notes.txt
            echo "**SHA256**: \`${SHA256}\`" >> release_notes.txt
          fi
          
          # Show final notes
          cat release_notes.txt
      
      - name: Find APK file
        if: steps.check_release.outputs.exists == 'false'
        id: apk
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APK_FILE="releases/SwitchToolkit-v${VERSION}.apk"
          
          if [ -f "$APK_FILE" ]; then
            echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
            echo "APK found: $APK_FILE"
            ls -lh "$APK_FILE"
          else
            echo "ERROR: APK not found: $APK_FILE"
            exit 1
          fi
      
      - name: Create GitHub Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Switch Toolkit ${{ steps.version.outputs.tag }}
          body_path: release_notes.txt
          files: |
            ${{ steps.apk.outputs.apk_path }}
            releases/release-info-v${{ steps.version.outputs.version }}.json
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release created
        if: steps.check_release.outputs.exists == 'false'
        run: |
          echo "âœ… Release created successfully!"
          echo "ðŸ“¥ Download: https://github.com/${{ github.repository }}/releases/latest"
